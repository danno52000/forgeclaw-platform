# Build Progress Log
Started: 2026-02-24
Feature: ForgeClaw API Validation Debugging Fix
Parent Task: 262

## Codebase Patterns
- Backend API is Express + Joi validation in portal-api/src/routes/
- Frontend is Next.js in forgeclaw-portal/src/pages/
- API base URL configured in forgeclaw-portal/src/config/api.ts (Render for prod, localhost:3001 for dev)
- Joi schemas defined at top of route files, validated inline in route handlers
- Frontend uses native fetch, not axios
---

## 2026-02-24 - Task 263: Add stripUnknown to backend Joi validation
Thread: https://ampcode.com/threads/T-019c9185-291f-728a-a583-e15c77971220
Task ID: 263
- Added `{ stripUnknown: true }` as second arg to both `validate()` calls in portal-api/src/routes/advisors.ts
  - Line 44: createAdvisorSchema.validate(req.body, { stripUnknown: true })
  - Line 185: updateSkillsSchema.validate(req.body, { stripUnknown: true })
- Files changed: portal-api/src/routes/advisors.ts
- Commit: 8a5e522
- **Learnings:** Git 2.25.1 on this VM doesn't support --trailer flag; use -F with a temp file instead.
---

## 2026-02-24 - Task 264: Surface Joi validation details in frontend error UI
Thread: https://ampcode.com/threads/T-019c9185-291f-728a-a583-e15c77971220
Task ID: 264
- Changed error handler in forgeclaw-portal/src/pages/signup.tsx (lines 142-146)
- Now joins errorData.details array into a comma-separated string and uses it as the error message
- Falls back to errorData.error, then generic message
- Files changed: forgeclaw-portal/src/pages/signup.tsx
- Commit: 72442da
- **Learnings:** Frontend error display uses `setError(error.message)` at line 154, so throwing with the details string surfaces it in the red error banner.
---

## 2026-02-24 - Frontend Form Completion: Step 2 & Step 4
Thread: https://ampcode.com/threads/T-019c9185-291f-728a-a583-e15c77971220
- Added Step 2 (Practice Details): practiceType, aum, clientCount, primaryCustodian â€” all as <select> dropdowns matching the optional Joi schema fields
- Added Step 4 (Configuration): subdomain (with inline .forgeclaw.com suffix + regex sanitizer), anthropicApiKey (password field), dataRetention (select dropdown defaulting to 90)
- Subdomain input auto-strips invalid chars via onChange: `.toLowerCase().replace(/[^a-z0-9-]/g, '')`
- Files changed: forgeclaw-portal/src/pages/signup.tsx
- **Learnings:** The form already had all state fields defined (lines 68-90), just missing the JSX render sections. Step 2 fields are all optional per backend Joi schema (.allow('').optional()), Step 4 subdomain + anthropicApiKey are required.
---

## 2026-02-24 - Fix NorthflankService: runtimeEnvironment format, internal nesting, error handling
Thread: https://ampcode.com/threads/T-019c9185-291f-728a-a583-e15c77971220
- **Bug 1 (Critical):** runtimeEnvironment was sent as array of {name, value} objects; Northflank API requires a flat object {KEY: "value"}. Fixed in createAdvisorInstance and updateAdvisorSkills.
- **Bug 2:** `internal` block (build service ref) was at top level of servicePayload; must be nested inside `deployment` per Northflank API docs.
- **Bug 3:** getAdvisorInstance env var reader used array .find() pattern; updated to read from object format.
- **Fix 3:** All error handlers now surface actual Northflank API error messages via extractErrorMessage() helper instead of generic strings.
- **Fix 4:** Constructor logs a warning if NORTHFLANK_API_TOKEN is not set.
- **Fix 5:** Route catch block in advisors.ts now includes `details` array so frontend displays the real error message.
- Files changed: portal-api/src/services/NorthflankService.ts, portal-api/src/routes/advisors.ts
- **Learnings:** Northflank API runtimeEnvironment is a flat object, NOT an array. The `internal` deployment source config must be nested inside the `deployment` object. Always check API docs against implementation.
---
